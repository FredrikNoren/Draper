"undefined"!=typeof exports&&(ko=require("../vendor/js/knockout-2.2.1.js"),inherits=require("./utils").inherits);var GraphActions={};"undefined"!=typeof module&&(module.exports=GraphActions),GraphActions.ActionBase=function(e){this.graph=e,this.dragObject=ko.observable(),this.performProgressBar=new ProgressBarViewModel("action-"+this.style+"-"+e.repoPath,1e3)},GraphActions.ActionBase.prototype.doPerform=function(e){var t=this;this.graph.hoverGraphAction(null),t.performProgressBar.start(),this.perform(e,function(){t.performProgressBar.stop()})},GraphActions.ActionBase.prototype.dragEnter=function(e){this.visible()&&(this.graph.hoverGraphAction(this),this.dragObject(e))},GraphActions.ActionBase.prototype.dragLeave=function(){this.visible()&&(this.graph.hoverGraphAction(null),this.dragObject(null))},GraphActions.ActionBase.prototype.mouseover=function(){this.graph.hoverGraphAction(this)},GraphActions.ActionBase.prototype.mouseout=function(){this.graph.hoverGraphAction(null)},GraphActions.Move=function(e,t){var r=this;GraphActions.ActionBase.call(this,e),this.node=t,this.visible=ko.computed(function(){return r.performProgressBar.running()?!0:r.graph.showDropTargets()&&r.graph.draggingRef().node()!=r.node})},inherits(GraphActions.Move,GraphActions.ActionBase),GraphActions.Move.prototype.text="Move",GraphActions.Move.prototype.style="move",GraphActions.Move.prototype.perform=function(e,t){e.current()?api.query("POST","/reset",{path:this.graph.repoPath,to:this.node.sha1},t):e.isTag?api.query("POST","/tags",{path:this.graph.repoPath,name:e.displayName,startPoint:this.node.sha1,force:!0},t):api.query("POST","/branches",{path:this.graph.repoPath,name:e.displayName,startPoint:this.node.sha1,force:!0},t)},GraphActions.Reset=function(e,t){var r=this;GraphActions.ActionBase.call(this,e),this.node=t,this.ref=this.dragObject,this.onto=ko.observable(this.node),this.visible=ko.computed(function(){return r.performProgressBar.running()?!0:r.graph.showDropTargets()&&r.graph.draggingRef().node()==r.node&&r.graph.draggingRef().remoteRef()&&r.graph.draggingRef().remoteRef().node()!=r.graph.draggingRef().node()&&!r.graph.draggingRef().remoteIsOffspring()})},inherits(GraphActions.Reset,GraphActions.ActionBase),GraphActions.Reset.prototype.text="Reset",GraphActions.Reset.prototype.style="reset",GraphActions.Reset.prototype.perform=function(e,t){api.query("POST","/reset",{path:this.graph.repoPath,to:e.remoteRef().name},t)},GraphActions.Pull=function(e,t){var r=this;GraphActions.ActionBase.call(this,e),this.node=t,this.ref=this.dragObject,this.onto=ko.observable(this.node),this.visible=ko.computed(function(){return r.performProgressBar.running()?!0:r.graph.showDropTargets()&&r.graph.draggingRef().node()==r.node&&r.graph.draggingRef().remoteRef()&&r.graph.draggingRef().remoteRef().node()!=r.graph.draggingRef().node()&&r.graph.draggingRef().remoteIsOffspring()})},inherits(GraphActions.Pull,GraphActions.ActionBase),GraphActions.Pull.prototype.text="Pull",GraphActions.Pull.prototype.style="pull",GraphActions.Pull.prototype.perform=function(e,t){api.query("POST","/reset",{path:this.graph.repoPath,to:e.remoteRef().name},t)},GraphActions.Rebase=function(e,t){var r=this;GraphActions.ActionBase.call(this,e),this.node=t,this.ref=this.dragObject,this.onto=ko.observable(this.node),this.visible=ko.computed(function(){return r.performProgressBar.running()?!0:r.graph.showDropTargets()&&(!ungit.config.showRebaseAndMergeOnlyOnRefs||r.node.refs().length>0)&&!r.node.isAncestor(r.graph.draggingRef().node())&&!r.graph.draggingRef().node().isAncestor(r.node)&&r.graph.draggingRef().current()})},inherits(GraphActions.Rebase,GraphActions.ActionBase),GraphActions.Rebase.prototype.text="Rebase",GraphActions.Rebase.prototype.style="rebase",GraphActions.Rebase.prototype.perform=function(e,t){api.query("POST","/rebase",{path:this.graph.repoPath,onto:this.node.sha1},function(e){if(e){if(e.errorCode="merge-failed")return t(),!0}else t()})},GraphActions.Merge=function(e,t){var r=this;GraphActions.ActionBase.call(this,e),this.node=t,this.ref=this.dragObject,this.mergeWith=ko.observable(this.node),this.visible=ko.computed(function(){return r.performProgressBar.running()?!0:r.graph.activeRef()&&r.graph.activeRef().node()?r.graph.showDropTargets()&&!r.graph.draggingRef().current()&&r.graph.activeRef().node()==r.node:!1})},inherits(GraphActions.Merge,GraphActions.ActionBase),GraphActions.Merge.prototype.text="Merge",GraphActions.Merge.prototype.style="merge",GraphActions.Merge.prototype.perform=function(e,t){api.query("POST","/merge",{path:this.graph.repoPath,"with":this.ref().displayName},function(e){if(e){if(e.errorCode="conflict")return t(),!0}else t()})},GraphActions.Push=function(e,t){var r=this;GraphActions.ActionBase.call(this,e),this.node=t,this.ref=this.dragObject,this.visible=ko.computed(function(){return r.performProgressBar.running()?!0:r.graph.showDropTargets()&&r.graph.draggingRef().node()==r.node&&r.graph.draggingRef().canBePushed()})},inherits(GraphActions.Push,GraphActions.ActionBase),GraphActions.Push.prototype.text="Push",GraphActions.Push.prototype.style="push",GraphActions.Push.prototype.perform=function(e,t){var r=this,n=function(e){"credentialsRequested"==e.event?r.performProgressBar.pause():"credentialsProvided"==e.event&&r.performProgressBar.unpause()};this.graph.repository.main.programEvents.add(n),api.query("POST","/push",{path:this.graph.repoPath,socketId:api.socketId,localBranch:e.displayName,remoteBranch:e.displayName},function(){r.graph.repository.main.programEvents.remove(n),r.graph.loadNodesFromApi(),t()})},GraphActions.Checkout=function(e,t){var r=this;GraphActions.ActionBase.call(this,e),this.node=t,this.ref=this.dragObject,this.visible=ko.computed(function(){return r.performProgressBar.running()?!0:r.graph.showDropTargets()&&r.graph.draggingRef().node()==r.node&&!r.graph.draggingRef().current()})},inherits(GraphActions.Checkout,GraphActions.ActionBase),GraphActions.Checkout.prototype.text="Checkout",GraphActions.Checkout.prototype.style="checkout",GraphActions.Checkout.prototype.perform=function(e,t){var r=this;api.query("POST","/checkout",{path:this.graph.repoPath,name:e.displayName},function(n){n&&"conflict"!=n.errorCode||(e.isRemoteBranch?api.query("POST","/reset",{path:r.graph.repoPath,to:e.name},t):t())})},GraphActions.Delete=function(e,t){var r=this;GraphActions.ActionBase.call(this,e),this.node=t,this.ref=this.dragObject,this.visible=ko.computed(function(){return r.performProgressBar.running()?!0:r.graph.showDropTargets()&&r.graph.draggingRef().node()==r.node&&!r.graph.draggingRef().current()})},inherits(GraphActions.Delete,GraphActions.ActionBase),GraphActions.Delete.prototype.text="Delete",GraphActions.Delete.prototype.style="delete",GraphActions.Delete.prototype.perform=function(e,t){var r=this,n=e.isTag?"/tags":"/branches";api.query("DELETE",n,{path:this.graph.repoPath,name:e.displayName,remote:e.isRemote},function(){t(),r.graph.loadNodesFromApi()})};