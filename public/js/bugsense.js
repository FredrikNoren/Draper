var bugsense;!function(e,t){"function"==typeof define&&define.amd?define(function(){return e.Bugsense=t()}):e.Bugsense=t()}(this,function(){var e=function(e,t){return Object.keys(t).forEach(function(n){e[n]=t[n]})},t=encodeURIComponent,n=function(e){return e instanceof Object},o=function(e){return e instanceof Array},i=function(e){return"string"==typeof e||"number"==typeof e||"boolean"==typeof e},r=function(e,t){Array.prototype.forEach.call(Object.keys(e),function(n){t(n,e[n])})},s=function p(e,t,i,s){var a=o(t);r(t,function(t,r){s&&(t=i?s:s+"["+(a?"":t)+"]"),!s&&a?e.add(r.name,r.value):(i?o(r):n(r))?p(e,r,i,t):e.add(t,r)})},a=function(e,n){var o=[];return o.add=function(e,n){this.push(t(e)+"="+t(n))},s(o,e,n),o.join("&").replace(/%20/g,"+")},c=function(){var e=function(){return Math.floor(65536*Math.random()).toString(16)};return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},d=function(t){if(e(this.config,t),this.config.winjs="undefined"!=typeof WinJS,this.extraData={},this.breadcrumbs=[],bugsense=this,"undefined"!=typeof this.config.context.onerror&&(this.config.context.onerror=bugsense.onerror),this.config.winjs){WinJS.Promise.onerror=bugsense.onpremiseerror;var n=Windows.ApplicationModel.Package.current.id.version;this.config.appversion=[n.major,n.minor,n.build,n.revision].join("."),this.send_cached_report_if_any();var o=Windows.Storage.ApplicationData.current.localSettings,i=o.guid;i||(i=c(),o.guid=i),this.config.guid=i}return this};return d.prototype.config={apiKey:"FOOBAR",url:"https://www.bugsense.com/api/errors",pingUrl:"http://ticks2.bugsense.com/api/ticks",appversion:null,popup:!1,callback:null,context:window,winjs:null,message:null},d.prototype.addExtraData=function(e,t){i(e)&&i(t)&&(this.extraData[e]=t)},d.prototype.removeExtraData=function(e){delete this.extraData[e]},d.prototype.clearExtraData=function(){this.extraData={}},d.prototype.leaveBreadcrumb=function(e){i(e)&&(16==this.breadcrumbs.length+1&&(this.breadcrumbs=this.breadcrumbs.slice(1)),this.breadcrumbs.push(e))},d.prototype.clearBreadcrumbs=function(){this.breadcrumbs={}},d.prototype._die=function(){throw"BugSense exited"},d.prototype.successHandler=function(e){if(!e.target||4==e.target.readyState){if(e.target&&200!=e.target.status&&bugsense.config.winjs)return!1;if("console"in window&&console.log("logged 1 error to Bugsense, status: "+e.target.responseText),bugsense.config.winjs)if(void 0!==e.target.responseText&&e.target.responseText.indexOf("url")>0){for(var t,n,o=JSON.parse(e.target.responseText),i=new Windows.UI.Popups.MessageDialog(o.data.tickerText),r=["Update","Cancel"],s=0;s<r.length;s++)n=new Windows.UI.Popups.UICommand,n.label=r[s],n.invoked=function(e){t=e.label},i.commands.append(n);i.showAsync().then(function(e){if("Update"==e.label){var t=Windows.Foundation.Uri(o.data.url);Windows.System.Launcher.launchUriAsync(t)}return e.label}).done(function(){window.bugsense._die()})}else if(e.target.responseText.length>0&&e.target.responseText.indexOf("url")<0)if(null!==window.bugsense.config.message){for(var t,n,i=new Windows.UI.Popups.MessageDialog(window.bugsense.config.message),r=["OK"],s=0;s<r.length;s++)n=new Windows.UI.Popups.UICommand,n.label=r[s],n.invoked=function(e){t=e.label},i.commands.append(n);i.showAsync().then(function(e){return e.label}).done(function(){window.bugsense._die()})}else window.bugsense._die()}},d.prototype.getPostURL=function(){return d.prototype.config.url+"?cacheBuster="+(new Date).getTime()},d.prototype.parseError=function(e){var t={};if(navigator.userAgent.toLowerCase().indexOf("firefox")>-1)t={message:e.message,url:window.location.href,line:e.lineNumber,stack:e.stack,type:e.name};else if(this.config.winjs===!0&&"undefined"==typeof e.stack)t={message:e.detail.errorMessage,url:e.detail.errorUrl,line:e.detail.errorLine,stack:void 0===e.detail.stack?e.detail.errorMessage:e.detail.stack,type:e.detail.errorCode};else if(this.config.winjs===!0&&"undefined"!=typeof e.stack){var n=e.stack,o=n.substr(n.indexOf("(")+1,n.indexOf(")")-n.indexOf("(")-1).split(":");t={message:e.message,url:o[0]+":"+o[1],line:o[2],stack:e.stack,type:e.stack.split(":")[0],handled:!0}}else{var i=e.stack.split("\n").slice(1)[0].match(/\s+at\s.*(\/.*\..*|<anonymous>:\d*:\d*)/);try{var o=e.stack}catch(e){e.stack=e.message}t={message:[e.name,e.message].join(": "),url:i[1].split(":")[0].replace("/",""),line:i[1].split(":")[1],stack:e.stack,type:e.name}}return(null==t.stack||"string"==typeof t.stack&&0==t.stack.length)&&(t.stack=t.message),t},d.prototype.generateExceptionData=function(e,t,n,o,i){"string"!=typeof e&&(e=e.toString());var r=window.navigator.userAgent,s="unknown";if(this.config.winjs)try{s=Windows.Networking.Connectivity.NetworkInformation.getInternetConnectionProfile().profileName}catch(a){s="Offline"}else"undefined"!=typeof window.navigator.network&&(s=window.navigator.network.connection.type);var c={client:{name:"bugsense-js",version:"1.1"},request:{custom_data:i},exception:{message:e,where:[t,n].join(":"),klass:e.split(":")[0],backtrace:"undefined"==typeof o?e:o,breadcrumbs:this.breadcrumbs},application_environment:{phone:window.navigator.platform,appver:this.config.appversion||"unknown",appname:this.config.appname||"unknown",osver:"undefined"!=typeof window.device?window.device.version:r.substr(r.indexOf("; ")+2,r.length).replace(")",";").split(";")[0]||"unknown",connection_type:s,user_agent:window.navigator.userAgent,cordova:"undefined"!=typeof window.device?window.device.cordova:"unknown",device_name:"undefined"!=typeof window.device?window.device.name:"unknown",log_data:this.extraData}};return this.config.winjs&&(c.application_environment.cpuClass=window.navigator.cpuClass,c.application_environment.osver=window.navigator.userAgent.split(";")[2],c.application_environment.languages=window.navigator.systemLanguage,c.application_environment.locale=window.navigator.userLanguage,c.application_environment.is_trial=Windows.ApplicationModel.Store.CurrentApp.licenseInformation.isTrial,c.application_environment.is_active=Windows.ApplicationModel.Store.CurrentApp.licenseInformation.isActive,c.application_environment.uid=this.config.guid,"undefined"!=typeof i&&"undefined"!=typeof i.handled&&(c.exception.handled=0)),c},d.prototype.testException=function(e){return this.config.winjs===!0&&"undefined"!=typeof e.detail?"error"===e.type:"[object Error]"===Object.prototype.toString.call(e)},d.prototype.isBugsenseException=function(e){return this.config.winjs&&this.testException(e)&&"BugSense exited"===e.detail.errorMessage},d.prototype.notify=function(e,t,n,o){var i;if(window.console&&window.console.error&&console.error(e.stack),2===arguments.length&&this.testException(e)&&(o=t,t=void 0),this.testException(e)){var r=this.parseError(e);message=[r.type,r.message].join(":"),t=r.url,n=r.line,i=r.stack,"undefined"!=typeof r.handled&&("object"!=typeof o&&(o={}),o.handled=0)}else message=e;var s=this.generateExceptionData(message,t,n,i,o),c=new XMLHttpRequest;return c.open("POST",this.getPostURL(),!0),c.setRequestHeader("X-BugSense-Api-Key",this.config.apiKey),c.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),c.onerror=function(){bugsense.config.winjs&&WinJS.Application.local.writeText("CachedCrashReport",JSON.stringify(s)).done(function(){console.log("written"),window.bugsense._die()})},o instanceof Object&&0==o.handled||(c.onreadystatechange=this.successHandler),c.send(a({data:JSON.stringify(s)})),!0},d.prototype.send_cached_report_if_any=function(){var e=WinJS.Application.local;e.exists("CachedCrashReport").then(function(t){t&&e.readText("CachedCrashReport").then(function(e){var t=JSON.parse(e),n=new XMLHttpRequest;n.open("POST",window.bugsense.getPostURL(),!0),n.setRequestHeader("X-BugSense-Api-Key",window.bugsense.config.apiKey),n.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),n.onreadystatechange=function(e){return e.target&&4==e.target.readyState?(WinJS.Application.local.remove("CachedCrashReport"),void 0):void 0},n.send(a({data:JSON.stringify(t)}))}).done()}).done()},d.prototype.onerror=function(e,t,n,o){return window.bugsense.isBugsenseException(e)?!1:window.bugsense.notify(e,t,n,o)},d.prototype.onpromiseerror=function(e){return window.bugsense.isBugsenseException(exception)?!1:window.bugsense.notify(e.detail.exception,e.detail.promise)},d});