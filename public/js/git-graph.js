"undefined"!=typeof exports&&(ko=require("../vendor/js/knockout-2.2.1.js"),Vector2=require("./vector2.js"),NodeViewModel=require("./node.js").NodeViewModel,RefViewModel=require("./ref.js").RefViewModel,GraphActions=require("./git-graph-actions.js"),ProgressBarViewModel=require("./controls.js").ProgressBarViewModel,moment=require("moment"),_=require("underscore"));var GitGraphViewModel=function(e){var t=this;this.maxNNodes=25,this.nodes=ko.observable([]),this.refs=ko.observableArray(),this.daySeparators=ko.observable(),this.nodesById={},this.refsByRefName={},this.repository=e,this.repoPath=e.repoPath,this.isLoading=ko.observable(!1),this.nodesLoader=new ProgressBarViewModel("gitgraph-"+e.repoPath,1e3,400),this.activeBranch=ko.observable(),this.activeRef=ko.computed(function(){return t.activeBranch()?t.getRef("refs/heads/"+t.activeBranch()):null}),this.HEAD=ko.observable(),this.hoverGraphAction=ko.observable(),this.draggingRef=ko.observable(),this.hasRemotes=ko.observable(!1),this.showDropTargets=ko.computed(function(){return!!t.draggingRef()})};"undefined"!=typeof exports&&(exports.GitGraphViewModel=GitGraphViewModel),GitGraphViewModel.prototype.updateAnimationFrame=function(e){this.nodes().forEach(function(t){t.updateAnimationFrame(e)})},GitGraphViewModel.prototype.scrolledToEnd=function(){this.maxNNodes=this.maxNNodes+10,this.loadNodesFromApi()},GitGraphViewModel.prototype.loadNodesFromApi=function(){var e=this;this.isLoading(!0),this.nodesLoader.start(),api.query("GET","/log",{path:this.repoPath,limit:this.maxNNodes},function(t,r){return t?(e.nodesLoader.stop(),void 0):(e.setNodesFromLog(r),e.isLoading(!1),e.nodesLoader.stop(),e.loadRemoteTagsFromApi(),void 0)})},GitGraphViewModel.prototype.loadRemoteTagsFromApi=function(){if(this.hasRemotes()){var e=this;api.query("GET","/remote/tags",{path:this.repoPath},function(t,r){if(t){if("remote-timeout"==t.errorCode)return e.repository.remoteErrorPopup("Repository remote timeouted"),!0;if("permision-denied-publickey"==t.errorCode)return e.repository.remoteErrorPopup("Permission denied (publickey)."),!0;if("offline"==t.errorCode)return e.repository.remoteErrorPopup("Couldn't reach remote repository, are you offline?"),!0;if(t.stderr&&0==t.stderr.indexOf("fatal: No remote configured to list refs from."))return!0}else r.forEach(function(t){if(-1!=t.name.indexOf("^{}")){var r="remote-tag: "+t.name.slice(0,t.name.length-"^{}".length),o=e.getRef(r),n=e.nodesById[t.sha1];if(n){o.node(n);var i=n.refs();-1==i.indexOf(o)&&(i.push(o),n.refs(i))}}})})}},GitGraphViewModel.prototype.setNodesFromLog=function(e){var t=this,r=[];e.forEach(function(e){e.graph=t;var o=t.nodesById[e.sha1]||new NodeViewModel(e);if(r.push(o),t.nodesById[e.sha1]=o,e.refs){var n=e.refs.map(function(e){var r=t.getRef(e);return r.node(o),r});n.sort(function(e,t){return e.isLocalBranch&&!t.isLocalBranch?-1:!e.isLocalBranch&&t.isLocalBranch?1:e.displayName<t.displayName?-1:1}),o.refs(n)}}),this.HEAD(GitGraphViewModel.getHEAD(r)),this.setNodes(r)},GitGraphViewModel.prototype.getRef=function(e){var t=this.refsByRefName[e];if(!t){var t=this.refsByRefName[e]=new RefViewModel({name:e,graph:this,color:GitGraphViewModel.randomColor()});this.refs.push(t)}return t},GitGraphViewModel.getHEAD=function(e){return _.find(e,function(e){return _.find(e.refs(),function(e){return e.isLocalHEAD})})},GitGraphViewModel.traverseNodeParents=function(e,t,r){e.index()>=this.maxNNodes||(r(e),e.parents.forEach(function(e){var o=t[e];o&&GitGraphViewModel.traverseNodeParents(o,t,r)}))},GitGraphViewModel.traverseNodeLeftParents=function(e,t,r){if(!(e.index()>=this.maxNNodes)){r(e);var o=t[e.parents[0]];o&&GitGraphViewModel.traverseNodeLeftParents(o,t,r)}},GitGraphViewModel.markNodesIdeologicalBranches=function(e,t){var r,o=function(e,r){GitGraphViewModel.traverseNodeParents(e,t,function(e){e.ideologicalBranch=r})},n=function(e){var t=_.find(e.refs(),function(e){return e.isBranch});return t&&t.isRemote&&t.localRef()&&(t=t.localRef()),t};e.forEach(function(e){var t=n(e);t&&("refs/heads/master"==t.name&&(r=e),o(e,t))}),r&&o(r,r.ideologicalBranch)},GitGraphViewModel.randomColor=function(){var e=function(){var e=Math.floor(256*Math.random()).toString(16);return 1==e.length&&(e="0"+e),e};return"#"+e()+e()+e()},GitGraphViewModel.prototype.setNodes=function(e){var t=[];e.sort(function(e,t){return t.commitTime.unix()-e.commitTime.unix()}),e.forEach(function(e,t){e.index(t)}),e=e.slice(0,GitGraphViewModel.maxNNodes);var r=this.HEAD();for(var o in this.refsByRefName){var n=this.refsByRefName[o];if(n.isLocalBranch){var i=this.refsByRefName["refs/remotes/origin/"+n.displayName];i&&(n.remoteRef(i),i.localRef(n),i.color=n.color)}}GitGraphViewModel.markNodesIdeologicalBranches(e,this.nodesById);var s=moment().valueOf();r&&GitGraphViewModel.traverseNodeLeftParents(r,this.nodesById,function(e){e.ancestorOfHEADTimeStamp=s}),e=e.filter(function(e){return!!e.ideologicalBranch||e.ancestorOfHEADTimeStamp==s});for(var a=[],p=30,c=e.length-1;c>=0;c--){var h=e[c];if(h.ancestorOfHEADTimeStamp!=s){var u=h.ideologicalBranch;if(u.lastSlottedTimeStamp!=s){u.lastSlottedTimeStamp=s;for(var d=0;d<a.length&&void 0!==a[d];d++);d==a.length&&(a.push(u),d=a.length-1),u.branchOrder=d,a[d]=d}h.branchOrder=u.branchOrder}}var l;e.forEach(function(e){var r=new Vector2;e.ancestorOfHEADTimeStamp==s?(p+=l?l.ancestorOfHEADTimeStamp==s?120:60:90,r.x=30,e.setRadius(30),e.ancestorOfHEAD(!0)):(p+=60,r.x=30+90*(a.length-e.branchOrder),e.setRadius(15),e.ancestorOfHEAD(!1)),r.y=p,e.setPosition(r);var o=86400;l&&Math.floor(l.commitTime.unix()/o)!=Math.floor(e.commitTime.unix()/o)&&t.push({x:0,y:r.y,date:e.commitTime.format("ll")}),l=e}),this.nodes(e),this.daySeparators(t)};